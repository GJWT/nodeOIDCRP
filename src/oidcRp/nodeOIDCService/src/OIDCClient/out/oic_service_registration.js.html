<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: oic/service/registration.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: oic/service/registration.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Service = require('../../service').Service;
const OIDCRequests = require('../../../nodeOIDCMsg/src/oicMsg/oic/requests');
const OIDCResponses = require('../../../nodeOIDCMsg/src/oicMsg/oic/responses');

let rt2gt = {
  'code': ['authorization_code'],
  'id_token': ['implicit'],
  'id_token token': ['implicit'],
  'code id_token': ['authorization_code', 'implicit'],
  'code token': ['authorization_code', 'implicit'],
  'code id_token token': ['authorization_code', 'implicit']
};

/**
 * Registration
 * @class
 * @constructor
 * @extends Service
 */
class Registration extends Service {
  constructor(serviceContext, stateDb, clientAuthnMethod=null, conf=null) {
    let service = super(serviceContext, stateDb, clientAuthnMethod, conf);
    this.msgType = OIDCRequests.RegistrationRequest;
    this.responseCls = OIDCResponses.RegistrationResponse;
    this.errorMsg =  OIDCResponses.ResponseMessage;
    this.endpointName = 'registrationEndpoint';
    this.synchronous = true;
    this.request = 'registration';
    this.bodyType = 'json';
    this.httpMethod = 'POST';
    let addRedirectUris = this.addRedirectUris;
    let addRequestUri = this.addRequestUri;
    let addJwksUriOrJwks = this.addJwksUriOrJwks;
    this.endpoint = 'https://example.org/op/registration';
    //    this.postParseResponse = [this.addClientBehavior, this.addRedirectUris, this.addRequestUr, this.addPostLogoutRedirectUris, this.addJwksUriOrJwks];
    //this.postParseResponse = [this.oicPostParseResponse];
    this.preConstruct = [this.addClientBehavior, this.addRedirectUris, this.addRequestUri, this.addPostLogoutRequestUris, this.addJwksUriOrJwks]   
    this.postConstruct = [this.oidcPostConstruct];
    return this;
  }

  addClientBehavior(requestArgs=null, request, params){
    request.msgType = new request.msgType();
    for (var i = 0; i &lt; Object.keys(request.msgType.cParam).length; i++){
      let prop = Object.keys(request.msgType.cParam)[i];
      if (Object.keys(requestArgs).indexOf(prop) !== -1){
        continue;
      }
      try{
        if (request.serviceContext.behavior[prop]){
          requestArgs[prop] = request.serviceContext.behavior[prop];
        }
      }catch(err){
        pass;
      }
    }
    let list = [requestArgs, {}];
    return list;
  }

  responseTypesToGrantTypes(responseTypes){
    let gt = []
    for (var i = 0; i &lt; responseTypes.length; i++){
      let responseType = responseTypes[i];
      try{
        gt = rt2gt[responseType];
      }catch(err){
        console.log(err);
      }
      return gt;
    }
  }

  oidcPostConstruct(requestArgs=null, params){
    try{
      let responseTypes = requestArgs.claims['response_types'];
      let gt = []
      for (var i = 0; i &lt; responseTypes.length; i++){
        let responseType = responseTypes[i];
        try{
          gt = rt2gt[responseType];
        }catch(err){
          console.log(err);
        }
      }

      requestArgs.claims['grant_types'] = gt;
    }catch(err){
      console.log(err);
    }
    return requestArgs;
  }

  updateServiceContext(resp, state='', params){
    this.serviceContext.registrationResponse = resp;
    if (Object.keys(this.serviceContext.registrationResponse).indexOf('token_endpoint_auth_method') == -1){
      this.serviceContext.registrationResponse['token_endpoint_auth_method'] = 'client_secret_basic';
    }
    this.serviceContext['client_id'] = resp['client_id'];

    if (resp['client_secret']){
      this.serviceContext['client_secret'] = resp['client_secret'];
    }else if (resp.claims['client_secret_expires_at']){
      this.serviceContext['client_secret_expires_at'] = resp['client_secret_expires_at'];
    }
    this.serviceContext['registration_access_token'] = resp['registration_access_token'];
  }

  /*
  addRedirectUris(requestArgs, serviceContext, params){
    let context = service.serviceContext;
    if (Object.keys(requestArgs).indexOf('redirect_uris') === -1){
      if (context.callback){
        requestArgs['redirect_uris'] = context.callback.values();
      }else{
        requestArgs['redirect_uris'] = context.redirect_uris;
      }
    }
    let list = [requestArgs, {}]
    return list;
  }
  
  addRequestUris(requestArgs=null, service=null, params){
    let context = service.serviceContext;
    if (context.requestDir){
      try{
        if (context.providerInfo['require_request_uri_registration']){
          requestArgs['request_uris'] = context.generateRequestUris(context.requestDir);
        }
      }catch(err){
        console.log(err);
      }
    }
    let list = [requestArgs, {}];
    return list;
  }
  
  function addPostLogoutRequestUris(requestArgs=null, service=null, params){
    let uris = [];
    if (Object.keys(requestArgs).indexOf('post_logout_redirect_uris') === -1){
      try{
        uris = service.serviceContext.post_logout_redirect_uris;
      }catch(err){
        console.log(err);
      }
      requestArgs['post_logout_redirect_uris'] = uris;
    }
    let list = [requestArgs, {}];
    return list;
  }
  
  function addJwksUriOrJwks(requestArgs=null, service=null, params){
    if (Object.keys(requestArgs).indexOf('jwks_uri') !== -1){
      if (Object.keys(requestArgs).indexOf('jwks') !== -1){
        delete requestArgs['jwks'];
      }
      let list = [requestArgs, {}];
      return list;
    }else if (Object.keys(requestArgs).indexOf('jwks') !== -1){
      let list = [requestArgs, {}];
      return list;
    }
  
    let jwksList = ['jwks_uri', 'jwks'];
    for (var i = 0; i &lt; jwksList; i++){
      let attr = jwksList[i];
      let val = service.serviceContext[attr];
      if (val){
        requestArgs[attr] = val;
        break;
      }else{
        try{
          val = service.serviceContext.config[attr];
        }catch(err){
          return
        }
        requestArgs[attr] = val;
        break;
      }
    }
    let list = [requestArgs, {}];
    return list;
  }
  */
}

module.exports.Registration = Registration;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AccessToken.html">AccessToken</a></li><li><a href="Authorization.html">Authorization</a></li><li><a href="BearerBody.html">BearerBody</a></li><li><a href="BearerHeader.html">BearerHeader</a></li><li><a href="CheckID.html">CheckID</a></li><li><a href="CheckSession.html">CheckSession</a></li><li><a href="ClientAuthnMethod.html">ClientAuthnMethod</a></li><li><a href="ClientSecretBasic.html">ClientSecretBasic</a></li><li><a href="ClientSecretJWT.html">ClientSecretJWT</a></li><li><a href="ClientSecretPost.html">ClientSecretPost</a></li><li><a href="EndSession.html">EndSession</a></li><li><a href="JRD.html">JRD</a></li><li><a href="JWSAuthnMethod.html">JWSAuthnMethod</a></li><li><a href="LINK.html">LINK</a></li><li><a href="OICCli.html">OICCli</a></li><li><a href="ProviderInfoDiscovery.html">ProviderInfoDiscovery</a></li><li><a href="RefreshAccessToken.html">RefreshAccessToken</a></li><li><a href="Registration.html">Registration</a></li><li><a href="Service.html">Service</a></li><li><a href="ServiceContext.html">ServiceContext</a></li><li><a href="State.html">State</a></li><li><a href="StateInterface.html">StateInterface</a></li><li><a href="URINormalizer.html">URINormalizer</a></li><li><a href="UserInfo.html">UserInfo</a></li><li><a href="Util.html">Util</a></li><li><a href="WebFinger.html">WebFinger</a></li></ul><h3>Global</h3><ul><li><a href="global.html#buildServices">buildServices</a></li><li><a href="global.html#Factory">Factory</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed May 23 2018 21:52:39 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
