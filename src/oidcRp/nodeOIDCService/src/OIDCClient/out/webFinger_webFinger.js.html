<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: webFinger/webFinger.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: webFinger/webFinger.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const WF_URL = 'https://%s/.well-known/webfinger';
const OIC_ISSUER = 'http://openid.net/specs/connect/1.0/issuer';
const URINormalizer = require('./uriNormalizer').URINormalizer;
const Service = require('../service').Service;

/**
 * WebFinger
 * @class
 * @constructor
 */
class WebFinger extends Service{
  constructor(serviceContext, stateDb, clientAuthnMethod, conf, rel, params) {
    super(serviceContext, stateDb, clientAuthnMethod, conf);
    this.jrd = null;
    this.events = null;
    this.request = 'webfinger';
    this.httpMethod = 'GET';
    this.responseBodyType = 'json';
    this.synchronous = true;
    this.defaultRel = rel|| OIC_ISSUER;
    return this;
  }

  init(defaultRel, httpD) {
    this.defaultRel = defaultRel || null;
    this.httpD = httpD || null;

  }

  query(resource, rel) {
    rel = rel || null;
    let uriNormalizer = new URINormalizer();
    resource = uriNormalizer.normalize(resource);
    let info = {};
    info['resource'] = resource;
    if (rel == null) {
      if (this.defaultRel) {
        info['rel'] = this.defaultRel;
      }
    } else if (rel instanceof String) {
      info['rel'] = rel;
    } else {
      for (let i = 0; i &lt; rel.length; i++) {
        let val = rel[i];
        if (info['rel']) {
          info['rel'].push(val);
        } else {
          info['rel'] = [val];
        }
      }
    }
    if (resource.startsWith('http')) {
      let part = urlParse(resource);
      var host = part.hostName;
      if (part.port !== null) {
        host += ':' + str(part.port);
      }
    } else if (resource.startsWith('acct:')) {
      let list = resource.split('@');
      host = list[list.length - 1];
      host = host.replace('/', '#').replace('?', '#').split('#')[0];
    } else if (resource.startsWith('device:')) {
      host = resource.split(':')[1];
    } else {
      console.log('Unknown schema');
    }
    return WF_URL.replace('%s', host) + '?' + this.urlEncode(info);
  }

  getRequestParameters({requestArgs=null, params}){
    if (!requestArgs){
      requestArgs = {};
    }

    let resource = '';
    if (requestArgs &amp;&amp; requestArgs['resource']){
      resource = requestArgs['resource'];
    }
    else if (params &amp;&amp; params['resource']){
      resource = params['resource'];
    } else if (this.serviceContext.config['resource']){
      resource = this.serviceContext.config['resource'];
    }else{
      //throw new JSError('resource', 'MissingRequiredAttribute');
    }

    if (params &amp;&amp; Object.keys(params).indexOf('rel') !== -1){
      return {'url' : this.query(resource, params['rel']), 'method': 'GET'};
    }else{
      return {'url' : this.query(resource), 'method' : 'GET'};
    }
  }

  urlEncode(dict) {
    let str = [];
    for (let i = 0; i &lt; Object.keys(dict).length; i++) {
      let key = Object.keys(dict)[i];
      let val = dict[key];
      if (val instanceof Array) {
        for (let i = 0; i &lt; val.length; i++) {
          str.push(
              encodeURIComponent('rel') + '=' + encodeURIComponent(val[i]));
        }
      } else {
        str.push(encodeURIComponent(key) + '=' + encodeURIComponent(val));
      }
    }
    return str.join('&amp;');
  }

  load(item) {
    return JRD(json.loads(item));
  }

  httpArgs(jrd) {
    if (jrd == null) {
      if (this.jrd) {
        jrd = this.jrd;
      } else {
        return null;
      }
    }
    return {
      'headers': {
        'Access-Control-Allow-Origin': '*',
        'Content-Type': 'application/json; charset=UTF-8'
      },
      'body': json.dumps(jrd.export())
    };
  }

  /**
   * Given a resource find a OpenID connect OP to use
   * @param {*} resource An identifier of an entity
   */
  discoveryQuery(resource) {
    url = this.query(resource, OIC_ISSUER);
    try {
      rsp = this.httpd(url, true);
    } catch (err) {
      console.log(err);
    }

    let statusCodes = [302, 301, 307];
    if (rsp.statusCode === 200) {
      if (this.events) {
        this.events.store('Response', rsp.text);
      }
      this.jrd = this.load(rsp.text);
      if (this.events) {
        this.events.store('JRD Response', this.jrd);
      }
      for (let i = 0; i &lt; this.jrd['links']; i++) {
        if (link['rel'] === OIC_ISSUER) {
          if (!link['href'].startsWith('https://')) {
            console.log(' Must be a HTTPS href');
          }
          return link['href'];
        }
      }
      return null;
    } else if (statusCodes.indexOf(rsp.statusCode)) {
      return this.discoveryQuery(rsp.headers['location']);
    } else {
      console.log(rsp.statusCode);
    }
  }

  response(subject, base, params) {
    this.jrd = JRD();
    this.jrd['subject'] = subject;
    link = LINK();
    link['rel'] = OIC_ISSUER;
    link['href'] = base;
    this.jrd['links'] = [link];
    for (let i = 0; i &lt; params.items().length; i++) {
      this.jrd[k] = v;
    }
    return json.dumps(this.jrd.export());
  }

  updateServiceContext(resp, state, params){
    if (resp['links']){
      let links  = resp['links'];
      for (var i = 0; i &lt; links.length; i++){
        let link = links[i];
        if (link['rel'] == this.defaultRel){
          let href = link['href'];
          if (!(this.conf &amp;&amp; this.conf['allow_http_links'])){
            if (href.startsWith('http://')){
              // throw new JSError('http link not allowed', 'ValueError');
            }
          }
          this.serviceContext.issuer = link['href'];
          break;
        }
      }
    }else{
      // throw new JSError('Missing Required Attribute - links', MissingRequiredAttribute);
    }
    return resp;
  }
}

module.exports.WebFinger = WebFinger;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AccessToken.html">AccessToken</a></li><li><a href="Authorization.html">Authorization</a></li><li><a href="BearerBody.html">BearerBody</a></li><li><a href="BearerHeader.html">BearerHeader</a></li><li><a href="CheckID.html">CheckID</a></li><li><a href="CheckSession.html">CheckSession</a></li><li><a href="ClientAuthnMethod.html">ClientAuthnMethod</a></li><li><a href="ClientSecretBasic.html">ClientSecretBasic</a></li><li><a href="ClientSecretJWT.html">ClientSecretJWT</a></li><li><a href="ClientSecretPost.html">ClientSecretPost</a></li><li><a href="EndSession.html">EndSession</a></li><li><a href="JRD.html">JRD</a></li><li><a href="JWSAuthnMethod.html">JWSAuthnMethod</a></li><li><a href="LINK.html">LINK</a></li><li><a href="OICCli.html">OICCli</a></li><li><a href="ProviderInfoDiscovery.html">ProviderInfoDiscovery</a></li><li><a href="RefreshAccessToken.html">RefreshAccessToken</a></li><li><a href="Registration.html">Registration</a></li><li><a href="Service.html">Service</a></li><li><a href="ServiceContext.html">ServiceContext</a></li><li><a href="State.html">State</a></li><li><a href="StateInterface.html">StateInterface</a></li><li><a href="URINormalizer.html">URINormalizer</a></li><li><a href="UserInfo.html">UserInfo</a></li><li><a href="Util.html">Util</a></li><li><a href="WebFinger.html">WebFinger</a></li></ul><h3>Global</h3><ul><li><a href="global.html#buildServices">buildServices</a></li><li><a href="global.html#Factory">Factory</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed May 23 2018 21:52:39 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
