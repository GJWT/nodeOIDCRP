<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: oic/service/userInfo.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: oic/service/userInfo.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Service = require('../../service');
const Message = require('../../../nodeOIDCMsg/src/oicMsg/message');

/**
 * UserInfo
 * @class
 * @constructor
 */
class UserInfo extends Service {
  constructor() {
    super();
    this.msgType = Message;
    this.endpointName = 'userinfo_endpoint';
    this.synchronous = true;
    this.request = 'userinfo';
    this.defaultAuthnMethod = 'bearer_header';
    this.httpMethod = 'GET';
    this.preConstruct = [this.oicPreConstruct];
  }

  init(httpLib, keyJar, clientAuthnMethod) {
    super.init(httpLib, keyJar, clientAuthnMethod);
    this.preConstruct = [this.oicPreConstruct];
    this.postParseResponse = [this.oicPostParseResponse];
  }

  oicPreConstruct(cliInfo, requestArgs, kwargs) {
    if (requestArgs === null) {
      requestArgs = {};
    }

    if (Object.keys(requestArgs).indexOf('accessToken') !== -1) {
      return;
    } else {
      let tInfo = cliInfo.stateDb.getTokenInfo(kwargs);
      requestArgs['access_token'] = tInfo['access_token'];
    }
    let list = [requestArgs, {}];
    return list;
  }

  oicPostParseResponse(resp, cliInfo, kwargs) {
    resp = this.unpackAggregatedClaims(resp, clientInfo);
    return this.fetchDistributedClaims(resp, clientInfo);
  }

  unpackAggregatedClaims(userInfo, cliInfo) {
    let csrc = null;
    try {
      csrc = userInfo['claimsSources'];
    } catch (err) {
      console.log(err);
    }
    for (let i = 0; i &lt; csrc.items().length; i++) {
      let pair = csrc.items()[i];
      let csrc = pair[0];
      let spec = pair[1];
      if (spec.indexOf('JWT')) {
        let aggregatedClaims =
            Message().fromJwt(spec['JWT'].encode('utf-8'), cliInfo.keyJar);
        for (let i = 0; i &lt; userInfo['claimNames'].items(); i++) {
          userInfo[key] = aggregatedClaims[key];
        }
      }
    }
    return userInfo;
  }

  fetchDistributedClaims(userInfo, cliInfo, callBack) {
    callBack = callBack || null;
    try {
      csrc = userInfo['claimSources'];
    } catch (err) {
      console.log(err);
    }
    let uInfo = null;
    for (let i = 0; i &lt; csrc.items().length; i++) {
      if (spec.indexOf('endpoint') !== -1) {
        if (spec.indexOf('accessToken')) {
          let uInfo = this.serviceRequest(
              spec['endpoint'], 'GET', spec['accessToken'], cliInfo);
        } else {
          if (callback) {
            uInfo = this.serviceRequest(
                spec['endpoint'], 'GET', callback(spec['endpoint']), cliInfo);
          } else {
            uInfo = this.serviceRequest(spec['endpoint'], 'GET', cliInfo);
          }
        }

        let claims = [];
        for (let i = 0; i &lt; userInfo['claimNames'].items().length; i++) {
          let pair = userInfo['claimNames'].items()[i];
          let value = pair[0];
          let src = pair[1];
          if (src === csrc) {
            claims.push(value);
          }
        }

        if (set(claims) !== set(uinfo.keys())) {
          console.log(
              'Claims from claim source doesn\'t match what\'s in the user info');
        }

        for (let i = 0; i &lt; uinfo.items(); i++) {
          let pair = uinfo.items()[i];
          let key = pair[0];
          let val = pair[1];
          userInfo[key] = vals;
        }
      }
    }
    return userInfo;
  }

  setIdToken(cliInfo, requestArgs, kwargs) {
    if (requestArgs === null) {
      requestArgs = {};
    }
    try {
      let prop = kwargs['prop'];
    } catch (err) {
      prop = 'idToken';
    }
    if (requestArgs.indexOf(prop) !== -1) {
      return;
    } else {
      let state = this.getState(requestArgs, kwargs);
      let idToken = cliInfo.stateDb.getIdToken(state);
      if (idToken == null) {
        console.log('No valid id token available');
      }
      requestArgs[prop] = idToken;
    }
    return requestArgs;
  }
}

module.exports.UserInfo = UserInfo;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AccessToken.html">AccessToken</a></li><li><a href="Authorization.html">Authorization</a></li><li><a href="BearerBody.html">BearerBody</a></li><li><a href="BearerHeader.html">BearerHeader</a></li><li><a href="CheckID.html">CheckID</a></li><li><a href="CheckSession.html">CheckSession</a></li><li><a href="Client.html">Client</a></li><li><a href="ClientAuthnMethod.html">ClientAuthnMethod</a></li><li><a href="ClientInfo.html">ClientInfo</a></li><li><a href="ClientSecretBasic.html">ClientSecretBasic</a></li><li><a href="ClientSecretJWT.html">ClientSecretJWT</a></li><li><a href="ClientSecretPost.html">ClientSecretPost</a></li><li><a href="EndSession.html">EndSession</a></li><li><a href="JRD.html">JRD</a></li><li><a href="JWSAuthnMethod.html">JWSAuthnMethod</a></li><li><a href="LINK.html">LINK</a></li><li><a href="OICCli.html">OICCli</a></li><li><a href="ProviderInfoDiscovery.html">ProviderInfoDiscovery</a></li><li><a href="RefreshAccessToken.html">RefreshAccessToken</a></li><li><a href="Registration.html">Registration</a></li><li><a href="Service.html">Service</a></li><li><a href="State.html">State</a></li><li><a href="StateJWT.html">StateJWT</a></li><li><a href="URINormalizer.html">URINormalizer</a></li><li><a href="UserInfo.html">UserInfo</a></li><li><a href="Util.html">Util</a></li><li><a href="WebFinger.html">WebFinger</a></li></ul><h3>Global</h3><ul><li><a href="global.html#buildServices">buildServices</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Mar 09 2018 11:36:25 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
